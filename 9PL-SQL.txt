9. Write an Unnamed PL/SQL. code block with the following table:
1. Borrower (Roll_no, Name, Dateoflssue, NameofBook, Status)
2. Fine (Roll_no, Date, Amt)
a) Accept Roll_no and NameofBook from user.
b) Check the number of days (from date of issue).
c) If days are between 15 to 30 then fine amount will be Rs Sper day.
d) If no. of days 30, per day fine will be Rs 50 per day and for days less than 30, Rs. 5 per day. e) After submitting the book, status will change from I to R.
f) If condition of fine is true, then details will be stored into fine table.
g) It should also handle the exception by named exception handler or user define exception handler.



-- make sure youâ€™re in the right database (the one where Borrower/Fine exist)
-- USE bankdb12;   -- or whichever DB you used for the tables

DROP PROCEDURE IF EXISTS Calculate_Fine;

DELIMITER $$

CREATE PROCEDURE Calculate_Fine(
  IN p_rollno INT,
  IN p_book   VARCHAR(100)
)
BEGIN
  DECLARE v_issue_date DATE;
  DECLARE v_days  INT DEFAULT 0;
  DECLARE v_fine  DECIMAL(10,2) DEFAULT 0;
  DECLARE v_found TINYINT DEFAULT 1;

  -- If the SELECT finds no row, set v_found=0 instead of throwing an error
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_found = 0;

  SELECT DateOfIssue
    INTO v_issue_date
  FROM Borrower
  WHERE Rollno = p_rollno
    AND NameOfBook = p_book
    AND Status = 'I'
  LIMIT 1;

  IF v_found = 0 THEN
    SELECT 'No record found for given Roll No and Book (or not currently issued).' AS Message;
  ELSE
    -- days since issue
    SET v_days = DATEDIFF(CURDATE(), v_issue_date);

    -- fine rules
    IF v_days > 30 THEN
      SET v_fine = v_days * 50;
    ELSEIF v_days BETWEEN 15 AND 30 THEN
      SET v_fine = v_days * 5;
    ELSE
      SET v_fine = 0;
    END IF;

    -- mark returned
    UPDATE Borrower
    SET Status = 'R'
    WHERE Rollno = p_rollno
      AND NameOfBook = p_book;

    -- insert fine if any
    IF v_fine > 0 THEN
      INSERT INTO Fine (Rollno, TxnDate, Amt)
      VALUES (p_rollno, CURDATE(), v_fine);
      SELECT CONCAT('Fine generated: Rs ', v_fine) AS Message;
    ELSE
      SELECT 'No fine applicable.' AS Message;
    END IF;
  END IF;
END$$

DELIMITER ;






-- See current data first
SELECT * FROM Borrower;
SELECT * FROM Fine;

-- Calls
CALL Calculate_Fine(1, 'DBMS');
CALL Calculate_Fine(2, 'CN');
CALL Calculate_Fine(3, 'OS');  -- should say "No record found..."

-- Results
SELECT * FROM Borrower;
SELECT * FROM Fine;

